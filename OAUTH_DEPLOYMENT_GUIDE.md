# OAuth Production Deployment Guide

## Overview

This guide provides step-by-step instructions to deploy OAuth authentication to production on Railway (backend) and Vercel (frontend).

## Prerequisites

- Railway CLI installed and authenticated
- Vercel CLI installed and authenticated (optional)
- Access to Google Cloud Console
- Production domains configured:
  - Frontend: `https://grateful-net.vercel.app`
  - Backend: `https://grateful-production.up.railway.app`

## Step 1: Configure Google OAuth Console

### 1.1 Update Redirect URIs

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Navigate to "APIs & Services" â†’ "Credentials"
3. Find your OAuth 2.0 Client ID (format: `[CLIENT_ID].apps.googleusercontent.com`)
4. Add these **Authorized redirect URIs**:
   ```
   https://grateful-net.vercel.app/auth/callback/google
   https://www.grateful-net.vercel.app/auth/callback/google
   ```

### 1.2 Update JavaScript Origins

Add these **Authorized JavaScript origins**:
```
https://grateful-net.vercel.app
https://www.grateful-net.vercel.app
```

### 1.3 Save Configuration

Click "Save" to apply the changes.

## Step 2: Set Railway Environment Variables

Run these commands in your terminal (requires Railway CLI):

```bash
# OAuth Configuration
railway variables set GOOGLE_CLIENT_ID="[YOUR_GOOGLE_CLIENT_ID]"
railway variables set GOOGLE_CLIENT_SECRET="[YOUR_GOOGLE_CLIENT_SECRET]"
railway variables set OAUTH_REDIRECT_URI="https://grateful-net.vercel.app/auth/callback/google"

# Session & Security (use the generated secrets from setup script)
railway variables set SESSION_SECRET="[GENERATED_32_CHAR_SECRET]"
railway variables set SECRET_KEY="[GENERATED_64_CHAR_JWT_SECRET]"

# CORS & Frontend
railway variables set ALLOWED_ORIGINS="https://grateful-net.vercel.app,https://www.grateful-net.vercel.app"
railway variables set FRONTEND_BASE_URL="https://grateful-net.vercel.app"

# Security Settings
railway variables set ENVIRONMENT="production"
railway variables set SECURE_COOKIES="true"
railway variables set COOKIE_HTTPONLY="true"
railway variables set COOKIE_SAMESITE="Lax"

# Content Security Policy
railway variables set CSP_DOMAINS="https://grateful-net.vercel.app https://www.grateful-net.vercel.app"
```

**Note:** Replace `[GENERATED_32_CHAR_SECRET]` and `[GENERATED_64_CHAR_JWT_SECRET]` with the actual secrets generated by running:
```bash
python scripts/setup_oauth_production.py
```

## Step 3: Set Vercel Environment Variables

### Option A: Using Vercel Dashboard

1. Go to [Vercel Dashboard](https://vercel.com/dashboard)
2. Select your project
3. Go to "Settings" â†’ "Environment Variables"
4. Add these variables for **Production** environment:

```
NODE_ENV=production
NEXT_PUBLIC_APP_URL=https://grateful-net.vercel.app
NEXT_PUBLIC_API_URL=https://grateful-production.up.railway.app
NEXT_TELEMETRY_DISABLED=1
```

### Option B: Using Vercel CLI

```bash
vercel env add NODE_ENV production
vercel env add NEXT_PUBLIC_APP_URL https://grateful-net.vercel.app
vercel env add NEXT_PUBLIC_API_URL https://grateful-production.up.railway.app
vercel env add NEXT_TELEMETRY_DISABLED 1
```

## Step 4: Deploy Applications

### 4.1 Deploy Backend to Railway

1. **Push to main branch** (triggers auto-deploy):
   ```bash
   git add .
   git commit -m "Configure OAuth for production"
   git push origin main
   ```

2. **Monitor deployment** in Railway dashboard
3. **Verify deployment** at: `https://grateful-production.up.railway.app/health`

### 4.2 Deploy Frontend to Vercel

1. **Push to main branch** (triggers auto-deploy):
   ```bash
   git push origin main
   ```

2. **Monitor deployment** in Vercel dashboard
3. **Verify deployment** at: `https://grateful-net.vercel.app`

## Step 5: Test OAuth Configuration

### 5.1 Run Production Test Script

```bash
cd apps/api
python scripts/test_oauth_production.py \\
  --frontend-url https://grateful-net.vercel.app \\
  --backend-url https://grateful-production.up.railway.app
```

### 5.2 Manual OAuth Flow Test

1. Navigate to `https://grateful-net.vercel.app`
2. Click "Sign in with Google"
3. Complete OAuth flow:
   - Redirected to Google OAuth
   - Grant permissions
   - Redirected back to app
   - Successfully logged in
4. Verify user data is saved correctly
5. Test logout functionality

## Step 6: Verify Production Configuration

### 6.1 Check OAuth Endpoints

Test these endpoints are accessible:
- `https://grateful-production.up.railway.app/api/v1/oauth/providers`
- `https://grateful-production.up.railway.app/api/v1/oauth/google/login`

### 6.2 Check Security Headers

```bash
curl -I https://grateful-production.up.railway.app/api/v1/oauth/providers
```

Should include:
- `X-Frame-Options: DENY`
- `X-Content-Type-Options: nosniff`
- `Strict-Transport-Security`
- `Content-Security-Policy`

### 6.3 Check CORS Configuration

```bash
curl -H "Origin: https://grateful-net.vercel.app" \\
     -H "Access-Control-Request-Method: POST" \\
     -H "Access-Control-Request-Headers: Content-Type" \\
     -X OPTIONS https://grateful-production.up.railway.app/api/v1/oauth/google/login
```

Should return CORS headers allowing the frontend domain.

## Troubleshooting

### Common Issues

#### 1. OAuth Endpoints Return 404

**Cause:** Environment variables not set or OAuth not initialized

**Solution:**
1. Verify all environment variables are set in Railway
2. Check Railway deployment logs for OAuth initialization errors
3. Ensure `GOOGLE_CLIENT_ID` and `GOOGLE_CLIENT_SECRET` are set

#### 2. Redirect URI Mismatch

**Cause:** Google Console redirect URIs don't match production URLs

**Solution:**
1. Update Google Console with exact production URLs
2. Ensure no trailing slashes or extra characters
3. Test with both `www` and non-`www` versions

#### 3. CORS Errors

**Cause:** Frontend domain not allowed in CORS configuration

**Solution:**
1. Verify `ALLOWED_ORIGINS` includes production frontend domain
2. Check CORS middleware configuration
3. Test CORS with curl command above

#### 4. Session/Cookie Issues

**Cause:** Insecure cookies or session configuration

**Solution:**
1. Verify `SECURE_COOKIES=true` in production
2. Check `SESSION_SECRET` is set and secure (32+ characters)
3. Ensure `COOKIE_SAMESITE=Lax` for cross-site requests

### Debug Commands

```bash
# Check Railway environment variables
railway variables

# Check Railway deployment logs
railway logs

# Test OAuth provider status
curl https://grateful-production.up.railway.app/api/v1/oauth/providers

# Test health endpoint
curl https://grateful-production.up.railway.app/health
```

## Security Checklist

- [ ] HTTPS enforced on all endpoints
- [ ] Secure session secrets (32+ characters)
- [ ] CORS restricted to production domains only
- [ ] Security headers enabled (CSP, HSTS, X-Frame-Options)
- [ ] OAuth credentials secured and not exposed in logs
- [ ] Production environment variables set correctly
- [ ] Google Console configured with exact production URLs

## Success Criteria

âœ… **OAuth endpoints accessible** (not 404)  
âœ… **Google OAuth flow completes successfully**  
âœ… **User authentication and session management works**  
âœ… **Security headers present and correct**  
âœ… **CORS allows frontend domain only**  
âœ… **Production test script passes >90% tests**  

## Next Steps

After successful OAuth deployment:

1. **Monitor OAuth usage** in production logs
2. **Set up alerts** for OAuth failures
3. **Plan additional providers** (Facebook, etc.)
4. **Regular security audits** of OAuth configuration
5. **Update documentation** with any production-specific findings

---

**OAuth Production Deployment Complete! ðŸš€**

Your OAuth authentication system is now live and ready for users.