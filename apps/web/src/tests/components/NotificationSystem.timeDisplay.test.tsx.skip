/**
 * Tests for NotificationSystem time display functionality
 */

import React from 'react'
import { render, screen, act } from '@testing-library/react'
import '@testing-library/jest-dom'
import NotificationSystem from '@/components/NotificationSystem'

// Jest globals
import { describe, it, expect, beforeEach, afterEach, jest } from '@jest/globals'

// Mock auth before importing
jest.mock('@/utils/auth');

import * as auth from '@/utils/auth';

// Mock fetch
global.fetch = jest.fn()

// Create mock functions
const mockGetAccessToken = jest.fn();
const mockIsAuthenticated = jest.fn();
const mockCanInteract = jest.fn();

// Assign mocks to the auth module
(auth.getAccessToken as jest.Mock) = mockGetAccessToken;
(auth.isAuthenticated as jest.Mock) = mockIsAuthenticated;
(auth.canInteract as jest.Mock) = mockCanInteract;

describe.skip('NotificationSystem Time Display', () => {
  // SKIPPED: Auth mock issues - Cannot set property getAccessToken
  // See SKIPPED_TESTS.md for details
  beforeEach(() => {
    jest.clearAllMocks()
    jest.useFakeTimers()

    mockGetAccessToken.mockReturnValue('mock-token');

    // Mock successful fetch response for notifications endpoint
    ;(global.fetch as jest.Mock).mockImplementation((url, options) => {
      if (url.includes('/api/notifications')) {
        if (options?.headers?.Authorization !== 'Bearer mock-token') {
          return Promise.resolve({ ok: false, status: 401, json: () => Promise.resolve({ error: 'Unauthorized' }) });
        }
        return Promise.resolve({
          ok: true,
          json: () => Promise.resolve([]) // Default empty notifications
        });
      }
      return Promise.reject(new Error('Unhandled fetch request: ' + url));
    });
  })

  afterEach(() => {
    jest.useRealTimers()
  })

  it('should display different relative times for notifications with different timestamps', async () => {
    const now = new Date('2025-08-26T18:00:00.000Z')
    jest.setSystemTime(now)

    const mockNotifications = [
      { id: '1', type: 'reaction', message: 'User1 reacted to your post', postId: 'post1', fromUser: { id: '1', name: 'user1' }, createdAt: '2025-08-26T17:00:00.000Z', read: false, isBatch: false },
      { id: '2', type: 'reaction', message: 'User2 reacted to your post', postId: 'post2', fromUser: { id: '2', name: 'user2' }, createdAt: '2025-08-26T17:30:00.000Z', read: false, isBatch: false },
      { id: '3', type: 'reaction', message: 'User3 reacted to your post', postId: 'post3', fromUser: { id: '3', name: 'user3' }, createdAt: '2025-08-26T17:59:00.000Z', read: false, isBatch: false }
    ];

    ;(fetch as jest.Mock).mockImplementationOnce((url, options) => {
      if (url.includes('/api/notifications')) {
        if (options?.headers?.Authorization !== 'Bearer mock-token') {
          return Promise.resolve({ ok: false, status: 401, json: () => Promise.resolve({ error: 'Unauthorized' }) });
        }
        return Promise.resolve({
          ok: true,
          json: () => Promise.resolve(mockNotifications)
        });
      }
      return Promise.reject(new Error('Unhandled fetch request: ' + url));
    });

    const { container } = render(<NotificationSystem userId={1} />)

    // Wait for component to mount and fetch data
    await act(async () => {
      jest.advanceTimersByTime(100)
    })

    // Open notifications
    const bellButton = screen.getByRole('button', { name: /Notifications/ })
    act(() => {
      bellButton.click()
    })

    // Check that different times are displayed
    expect(screen.getByText('User1 reacted to your post')).toBeInTheDocument();
    expect(screen.getByText('1h')).toBeInTheDocument();
    expect(screen.getByText('User2 reacted to your post')).toBeInTheDocument();
    expect(screen.getByText('30m')).toBeInTheDocument();
    expect(screen.getByText('User3 reacted to your post')).toBeInTheDocument();
    expect(screen.getByText('1m')).toBeInTheDocument();
  }, 10000)

  it('should update relative times when time passes', async () => {
    const now = new Date('2025-08-26T18:00:00.000Z')
    jest.setSystemTime(now)

    const mockNotifications = [
      {
        id: '1',
        type: 'reaction',
        message: 'User1 reacted to your post',
        postId: 'post1',
        fromUser: { id: '1', name: 'user1' },
        createdAt: '2025-08-26T17:59:00.000Z', // 1 minute ago initially
        read: false,
        isBatch: false
      }
    ]

    ;(fetch as jest.Mock).mockImplementationOnce((url, options) => {
      if (url.includes('/api/notifications')) {
        return Promise.resolve({
          ok: true,
          json: () => Promise.resolve(mockNotifications)
        });
      }
      return Promise.reject(new Error('Unhandled fetch request: ' + url));
    });
    render(<NotificationSystem userId={1} />)

    // Open notifications
    const bellButton = screen.getByRole('button', { name: /Notifications/ })
    act(() => {
      bellButton.click()
    })

    // Wait for notifications to load
    await act(async () => {
      jest.advanceTimersByTime(0)
    })

    // Initially should show "1m"
    const notificationList = screen.getByRole('list', { name: /Notification items/i });
    expect(notificationList).toHaveTextContent('User1 reacted to your post');
    expect(notificationList).toHaveTextContent('1m');

    // Advance time by 2 minutes
    act(() => {
      jest.advanceTimersByTime(2 * 60 * 1000) // 2 minutes
    })

    // Should now show "3m"
    expect(notificationList).toHaveTextContent('3m');
    expect(screen.queryByText('1m')).not.toBeInTheDocument()
  })

  it('should handle "Just now" for very recent notifications', async () => {
    const now = new Date('2025-08-26T18:00:00.000Z')
    jest.setSystemTime(now)

    const mockNotifications = [
      {
        id: '1',
        type: 'reaction',
        message: 'User1 reacted to your post',
        postId: 'post1',
        fromUser: { id: '1', name: 'user1' },
        createdAt: '2025-08-26T17:59:30.000Z', // 30 seconds ago
        read: false,
        isBatch: false
      }
    ]

    ;(fetch as jest.Mock).mockImplementationOnce((url, options) => {
      if (url.includes('/api/notifications')) {
        return Promise.resolve({
          ok: true,
          json: () => Promise.resolve(mockNotifications)
        });
      }
      return Promise.reject(new Error('Unhandled fetch request: ' + url));
    });
    render(<NotificationSystem userId={1} />)

    // Open notifications
    const bellButton = screen.getByRole('button', { name: /Notifications/ })
    act(() => {
      bellButton.click()
    })

    // Wait for notifications to load
    await act(async () => {
      jest.advanceTimersByTime(0)
    })

    // Should show "0s" for notifications less than 1 minute old
    const notificationList = screen.getByRole('list', { name: /Notification items/i });
    expect(notificationList).toHaveTextContent('User1 reacted to your post');
    expect(notificationList).toHaveTextContent('0s');
  })
})